#!/usr/bin/env bash
set -e

echo "pre-push: rebuilding mcp-server dist..."

cd "$(git rev-parse --show-toplevel)/mcp-server"
pnpm build

DIST="dist/index.js"
if [ ! -f "$DIST" ]; then
  echo "pre-push: build failed — $DIST not found" >&2
  exit 1
fi

# Stage and amend the dist into the latest commit if it changed
cd "$(git rev-parse --show-toplevel)"
if ! git diff --quiet -- "mcp-server/$DIST"; then
  echo "pre-push: dist changed — staging updated build..."
  git add "mcp-server/$DIST"
  git commit --amend --no-edit
  echo "pre-push: amended commit with fresh dist"
fi

echo "pre-push: done"
