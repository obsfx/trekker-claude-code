#!/usr/bin/env bash
set -e

ROOT="$(git rev-parse --show-toplevel)"
DIST="mcp-server/dist/index.js"

# Only rebuild if mcp-server source changed in this commit
if git diff --cached --name-only | grep -q '^mcp-server/src/'; then
  echo "pre-commit: mcp-server source changed, rebuilding dist..."
  cd "$ROOT/mcp-server"
  pnpm build

  if [ ! -f "dist/index.js" ]; then
    echo "pre-commit: build failed â€” dist/index.js not found" >&2
    exit 1
  fi

  cd "$ROOT"
  git add "$DIST"
  echo "pre-commit: staged fresh dist/index.js"
fi
