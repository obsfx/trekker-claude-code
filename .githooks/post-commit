#!/usr/bin/env bash
set -e

# Guard against re-entry (amend triggers post-commit again)
if [ -n "$TREKKER_POST_COMMIT" ]; then
  exit 0
fi
export TREKKER_POST_COMMIT=1

ROOT="$(git rev-parse --show-toplevel)"

# 1. Build MCP server
echo "post-commit: building mcp-server..."
cd "$ROOT/mcp-server"
pnpm build 2>/dev/null

if [ ! -f "dist/index.js" ]; then
  echo "post-commit: build failed â€” dist/index.js not found" >&2
  exit 0
fi

# 2. Bump patch version and sync across all version files
cd "$ROOT"
node -e "
const fs = require('fs');
const path = require('path');

const files = {
  pkg: 'mcp-server/package.json',
  plugin: '.claude-plugin/plugin.json',
  marketplace: '.claude-plugin/marketplace.json',
};

// Read and bump patch version from package.json
const pkg = JSON.parse(fs.readFileSync(files.pkg, 'utf8'));
const parts = pkg.version.split('.');
parts[2] = String(Number(parts[2]) + 1);
const newVersion = parts.join('.');

// Update package.json
pkg.version = newVersion;
fs.writeFileSync(files.pkg, JSON.stringify(pkg, null, 2) + '\n');

// Update plugin.json
const plugin = JSON.parse(fs.readFileSync(files.plugin, 'utf8'));
plugin.version = newVersion;
fs.writeFileSync(files.plugin, JSON.stringify(plugin, null, 2) + '\n');

// Update marketplace.json
const market = JSON.parse(fs.readFileSync(files.marketplace, 'utf8'));
if (market.plugins && market.plugins[0]) {
  market.plugins[0].version = newVersion;
}
fs.writeFileSync(files.marketplace, JSON.stringify(market, null, 2) + '\n');

console.log('post-commit: bumped version to ' + newVersion);
"

# 3. Stage updated files and amend the commit
git add mcp-server/dist/index.js \
       mcp-server/package.json \
       .claude-plugin/plugin.json \
       .claude-plugin/marketplace.json

if ! git diff --cached --quiet; then
  git commit --amend --no-edit --no-verify
  echo "post-commit: amended commit with build and version bump"
else
  echo "post-commit: no changes to amend"
fi
